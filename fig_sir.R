# Gotowy data frame (już policzona interpolacja dzienna + 7-dniowa średnia centrowana: 3 dni wstecz, 3 dni w przód)
txt <- c(
  "date,cases_obs,cases_interp,cases_7d",
  "2020-03-12,2,2.0,1.917",
  "2020-03-13,2,2.0,1.8",
  "2020-03-14,2,2.0,1.667",
  "2020-03-15,,1.667,1.714",
  "2020-03-16,,1.333,1.714",
  "2020-03-17,1,1.0,1.714",
  "2020-03-18,2,2.0,2.0",
  "2020-03-19,2,2.0,2.714",
  "2020-03-20,5,5.0,2.714",
  "2020-03-21,3,3.0,3.429",
  "2020-03-22,3,3.0,6.429",
  "2020-03-23,3,3.0,8.857",
  "2020-03-24,26,26.0,15.714",
  "2020-03-25,15,15.0,17.0",
  "2020-03-26,64,64.0,18.714",
  "2020-03-27,5,5.0,17.857",
  "2020-03-28,6,6.0,15.143",
  "2020-03-29,11,11.0,10.571",
  "2020-03-30,,10.0,11.714",
  "2020-03-31,9,9.0,13.857",
  "2020-04-01,34,34.0,14.857",
  "2020-04-02,9,9.0,14.0",
  "2020-04-03,1,1.0,17.714",
  "2020-04-04,9,9.0,20.714",
  "2020-04-05,,41.0,24.714",
  "2020-04-06,73,73.0,28.429",
  "2020-04-07,26,26.0,37.0",
  "2020-04-08,,45.5,43.357",
  "2020-04-09,65,65.0,52.071",
  "2020-04-10,30,30.0,68.214",
  "2020-04-11,158,158.0,74.214",
  "2020-04-12,,129.333,71.452",
  "2020-04-13,,100.667,83.214",
  "2020-04-14,70,70.0,76.19",
  "2020-04-15,5,5.0,93.619",
  "2020-04-16,,67.667,114.857",
  "2020-04-17,,130.333,140.857",
  "2020-04-18,193,193.0,151.524",
  "2020-04-19,208,208.0,168.19",
  "2020-04-20,,217.667,191.571",
  "2020-04-21,,227.333,212.333",
  "2020-04-22,237,237.0,228.714",
  "2020-04-23,,245.5,236.714",
  "2020-04-24,,254.0,243.643",
  "2020-04-25,271,271.0,242.786",
  "2020-04-26,,196.0,250.357",
  "2020-04-27,121,121.0,266.357",
  "2020-04-28,403,403.0,225.929",
  "2020-04-29,,300.333,214.024",
  "2020-04-30,,197.667,227.333",
  "2020-05-01,95,95.0,279.952",
  "2020-05-02,550,550.0,339.476",
  "2020-05-03,,461.0,429.0",
  "2020-05-04,372,372.0,549.571",
  "2020-05-05,,555.0,587.0",
  "2020-05-06,,738.0,618.0",
  "2020-05-07,921,921.0,633.143",
  "2020-05-08,251,251.0,589.0",
  "2020-05-09,,344.0,535.143",
  "2020-05-10,437,437.0,450.714",
  "2020-05-11,427,427.0,377.571",
  "2020-05-12,281,281.0,281.714",
  "2020-05-13,122,122.0,230.286",
  "2020-05-14,108,108.0,176.0",
  "2020-05-15,97,97.0,140.714",
  "2020-05-16,,140.0,153.857",
  "2020-05-17,183,183.0,160.714",
  "2020-05-18,178,178.0,169.571",
  "2020-05-19,173,173.0,176.714",
  "2020-05-20,217,217.0,156.714",
  "2020-05-21,131,131.0,141.143",
  "2020-05-22,66,66.0,138.857",
  "2020-05-23,125,125.0,138.857",
  "2020-05-24,156,156.0,143.714",
  "2020-05-25,153,153.0,173.429",
  "2020-05-26,186,186.0,199.571",
  "2020-05-27,313,313.0,195.0",
  "2020-05-28,152,152.0,185.714",
  "2020-05-29,113,113.0,196.0",
  "2020-05-30,189,189.0,199.571",
  "2020-05-31,227,227.0,222.857",
  "2020-06-01,251,251.0,252.714",
  "2020-06-02,337,337.0,269.286",
  "2020-06-03,283,283.0,268.429",
  "2020-06-04,294,294.0,269.286",
  "2020-06-05,176,176.0,275.714",
  "2020-06-06,272,272.0,264.429",
  "2020-06-07,291,291.0,275.714",
  "2020-06-08,157,157.0,294.429",
  "2020-06-09,498,498.0,298.429",
  "2020-06-10,262,262.0,286.0",
  "2020-06-11,304,304.0,304.571",
  "2020-06-12,295,295.0,288.0",
  "2020-06-13,247,247.0,301.571",
  "2020-06-14,229,229.0,305.143",
  "2020-06-15,397,397.0,297.571",
  "2020-06-16,339,339.0,314.857",
  "2020-06-17,274,274.0,332.429",
  "2020-06-18,514,514.0,325.0",
  "2020-06-19,290,290.0,336.429",
  "2020-06-20,147,147.0,383.143",
  "2020-06-21,414,414.0,387.714",
  "2020-06-22,445,445.0,391.571",
  "2020-06-23,460,460.0,433.0",
  "2020-06-24,361,361.0,474.286",
  "2020-06-25,597,597.0,479.429",
  "2020-06-26,311,311.0,475.571",
  "2020-06-27,609,609.0,468.571",
  "2020-06-28,390,390.0,510.714",
  "2020-06-29,393,393.0,586.571",
  "2020-06-30,,823.5,718.714",
  "2020-07-01,1254,1254.0,863.143",
  "2020-07-02,697,697.0,929.357",
  "2020-07-03,992,992.0,914.143",
  "2020-07-04,891,891.0,845.714",
  "2020-07-05,854,854.0,748.571",
  "2020-07-06,641,641.0,652.0",
  "2020-07-07,371,371.0,569.286",
  "2020-07-08,414,414.0,472.429",
  "2020-07-09,270,270.0,419.714",
  "2020-07-10,470,470.0,369.714",
  "2020-07-11,264,264.0,420.429",
  "2020-07-12,178,178.0,452.286",
  "2020-07-13,695,695.0,446.714",
  "2020-07-14,447,447.0,503.857",
  "2020-07-15,488,488.0,580.714",
  "2020-07-16,607,607.0,592.714",
  "2020-07-17,763,763.0,634.571",
  "2020-07-18,559,559.0,668.714",
  "2020-07-19,683,683.0,670.714",
  "2020-07-20,694,694.0,679.857",
  "2020-07-21,691,691.0,705.0",
  "2020-07-22,794,794.0,662.143",
  "2020-07-23,586,586.0,645.143",
  "2020-07-24,532,532.0,661.714",
  "2020-07-25,655,655.0,680.857",
  "2020-07-26,782,782.0,645.571",
  "2020-07-27,736,736.0,754.714",
  "2020-07-28,359,359.0,816.5",
  "2020-07-29,,936.0,966.286",
  "2020-07-30,1513,1513.0,963.286",
  "2020-07-31,798,798.0,939.286",
  "2020-08-01,689,689.0,722.286",
  "2020-08-02,574,574.0,606.286",
  "2020-08-03,567,567.0,534.0",
  "2020-08-04,455,455.0,508.571",
  "2020-08-05,436,436.0,471.714",
  "2020-08-06,470,470.0,375.143",
  "2020-08-07,209,209.0,331.0",
  "2020-08-08,192,192.0,276.143",
  "2020-08-09,168,168.0,184.286",
  "2020-08-10,153,153.0,161.714",
  "2020-08-11,122,122.0,168.143",
  "2020-08-12,216,216.0,159.143",
  "2020-08-13,147,147.0,180.714",
  "2020-08-14,322,322.0,192.429",
  "2020-08-15,121,121.0,219.571",
  "2020-08-16,340,340.0,198.571",
  "2020-08-17,83,83.0,190.286",
  "2020-08-18,184,184.0,159.714",
  "2020-08-19,65,65.0,137.714",
  "2020-08-20,180,180.0,116.571",
  "2020-08-21,117,117.0,111.286",
  "2020-08-22,95,95.0,98.0",
  "2020-08-23,52,52.0,100.0",
  "2020-08-24,72,72.0,111.143",
  "2020-08-25,108,108.0,108.714",
  "2020-08-26,169,169.0,124.286",
  "2020-08-27,87,87.0,133.5",
  "2020-08-28,,171.0,152.857",
  "2020-08-29,255,255.0,147.0",
  "2020-08-30,157,157.0,113.429",
  "2020-08-31,41,41.0,98.857",
  "2020-09-01,55,55.0,92.0",
  "2020-09-02,64,64.0,95.429",
  "2020-09-03,92,92.0,108.714",
  "2020-09-04,143,143.0,117.286",
  "2020-09-05,176,176.0,116.0",
  "2020-09-06,125,125.0,107.429",
  "2020-09-07,75,75.0,94.857",
  "2020-09-08,46,46.0,76.857",
  "2020-09-09,59,59.0,67.571",
  "2020-09-10,79,79.0,54.571",
  "2020-09-11,29,29.0,54.286",
  "2020-09-12,54,54.0,55.0",
  "2020-09-13,59,59.0,52.857",
  "2020-09-14,46,46.0,60.714",
  "2020-09-15,97,97.0,65.857",
  "2020-09-16,20,20.0,72.571",
  "2020-09-17,127,127.0,67.857",
  "2020-09-18,58,58.0,61.857",
  "2020-09-19,54,54.0,60.286",
  "2020-09-20,37,37.0,72.857",
  "2020-09-21,69,69.0,72.0",
  "2020-09-22,131,131.0,65.0",
  "2020-09-23,34,34.0,61.857",
  "2020-09-24,57,57.0,65.857",
  "2020-09-25,38,38.0,66.714",
  "2020-09-26,144,144.0,62.571",
  "2020-09-27,30,30.0,64.857",
  "2020-09-28,38,38.0,62.286",
  "2020-09-29,74,74.0,56.857",
  "2020-09-30,35,35.0,47.143"
)

gi_daily <- read.csv(text = txt, na.strings = c("", "NA"), stringsAsFactors = FALSE)
gi_daily$date <- as.Date(gi_daily$date)

gi_daily

library(deSolve)
library(dplyr)

# -----------------------
# 0) OBS: wybierz zakres dzienny zgodny z times = 0:202
# -----------------------
start_date <- as.Date("2020-03-12")
times <- 0:202
end_date <- start_date + max(times)

# gi_daily ma kolumny: date, cases_obs, cases_interp, cases_7d (z poprzedniego kroku)
obs_daily <- gi_daily %>%
  filter(date >= start_date, date <= end_date) %>%
  arrange(date) %>%
  mutate(time = as.integer(date - start_date)) %>%
  select(time, date, y = cases_7d)

stopifnot(nrow(obs_daily) == length(times))

# -----------------------
# 1) Parametry stałe modelu (Twoje nowe)
#    Fitujemy TYLKO red1 i red2
# -----------------------
S0 <- 21191800
I0 <- 5607
R0 <- 0
Inc0 <- 0

N  <- S0 + I0 + R0

beta <- 0.2416
v1   <- 0.044
v2   <- 0.1

t_start1 <- 18
t_end1   <- 37
t_start2 <- 21
t_end2   <- 179

scale_inc <- 0.003567  # Twoja skala dla Inc_day

# -----------------------
# 2) Symulacja -> dzienna incydencja (skalowana) w tym samym oknie czasowym
# -----------------------
simulate_daily_GI <- function(red1, red2,
                              beta, v1, v2, N,
                              t_start1, t_end1, t_start2, t_end2,
                              S0, I0, R0, Inc0,
                              start_date, times,
                              scale_inc = 1) {
  
  # zabezpieczenie zakresów
  if (red1 < 0 || red1 >= 1 || red2 < 0 || red2 >= 1) return(NULL)
  
  params <- c(
    beta = beta, v1 = v1, v2 = v2, N = N,
    t_start1 = t_start1, t_end1 = t_end1, red1 = red1,
    t_start2 = t_start2, t_end2 = t_end2, red2 = red2
  )
  
  init <- c(S = S0, I = I0, Inc = Inc0, R = R0)
  
  out <- ode(
    y = init, times = times, func = sir_intervention_model,
    parms = params, method = "lsoda"
  ) %>% as.data.frame()
  
  out <- out %>%
    arrange(time) %>%
    mutate(
      date = start_date + time,
      Inc_day = scale_inc * c(Inc[1], diff(Inc))  # KLUCZ: dzienna incydencja z kumulatywnej Inc
    ) %>%
    select(time, date, pred = Inc_day)
  
  out
}

# -----------------------
# 3) Funkcja straty SSE względem cases_7d
# -----------------------
loss_red1_red2_daily <- function(red1, red2) {
  
  pred_daily <- simulate_daily_GI(
    red1 = red1, red2 = red2,
    beta = beta, v1 = v1, v2 = v2, N = N,
    t_start1 = t_start1, t_end1 = t_end1,
    t_start2 = t_start2, t_end2 = t_end2,
    S0 = S0, I0 = I0, R0 = R0, Inc0 = Inc0,
    start_date = start_date, times = times,
    scale_inc = scale_inc
  )
  
  if (is.null(pred_daily)) return(Inf)
  
  comp <- obs_daily %>%
    inner_join(pred_daily, by = c("time", "date")) %>%
    mutate(err = pred - y)
  
  sum(comp$err^2, na.rm = TRUE)
}

# -----------------------
# 4) Grid search po red1 i red2
#    (możesz zagęścić siatkę wokół minimum w drugim kroku)
# -----------------------
red1_grid <- seq(0.00, 0.90, by = 0.02)
red2_grid <- seq(0.00, 0.50, by = 0.01)

param_grid <- expand.grid(red1 = red1_grid, red2 = red2_grid)
param_grid$loss <- NA_real_

for (i in seq_len(nrow(param_grid))) {
  param_grid$loss[i] <- loss_red1_red2_daily(param_grid$red1[i], param_grid$red2[i])
}

best <- param_grid[which.min(param_grid$loss), ]
best

# -----------------------
# 5) (opcjonalnie) Wyciągnij najlepszą trajektorię i porównaj z cases_7d
# -----------------------
best_pred <- simulate_daily_GI(
  red1 = best$red1, red2 = best$red2,
  beta = beta, v1 = v1, v2 = v2, N = N,
  t_start1 = t_start1, t_end1 = t_end1,
  t_start2 = t_start2, t_end2 = t_end2,
  S0 = S0, I0 = I0, R0 = R0, Inc0 = Inc0,
  start_date = start_date, times = times,
  scale_inc = scale_inc
)

fit_df <- obs_daily %>%
  inner_join(best_pred, by = c("time", "date")) %>%
  select(date, y_cases7d = y, pred_inc = pred)

fit_df

